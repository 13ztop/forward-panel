name: Auto Sync from bqlpfy/forward-panel

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰è‡ªåŠ¨åŒæ­¥
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤ 1: éªŒè¯å¿…è¦çš„ Secrets
      - name: Verify Secrets
        run: |
          if [ -z "${{ secrets.SYNC_TOKEN }}" ]; then
            echo "::error::SYNC_TOKENæœªè®¾ç½®"
            exit 1
          fi
          
          if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] && [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            echo "TELEGRAM_ENABLED=true" >> $GITHUB_ENV
          else
            echo "TELEGRAM_ENABLED=false" >> $GITHUB_ENV
          fi
          echo "SecretséªŒè¯é€šè¿‡"

      # æ­¥éª¤ 2: è·å–ç›®æ ‡ä»“åº“é»˜è®¤åˆ†æ”¯
      - name: Detect default branch
        run: |
          DEFAULT_BRANCH=$(curl -s -H "Authorization: token ${{ secrets.SYNC_TOKEN }}" \
          "https://api.github.com/repos/13ztop/forward-panel" | jq -r .default_branch)
          
          if [ -z "$DEFAULT_BRANCH" ] || [ "$DEFAULT_BRANCH" = "null" ]; then
            DEFAULT_BRANCH="main"
          fi
          echo "DEFAULT_BRANCH=$DEFAULT_BRANCH" >> $GITHUB_ENV
          echo "ä½¿ç”¨åˆ†æ”¯: $DEFAULT_BRANCH"

      # æ­¥éª¤ 3: è®¾ç½®æ—¶é—´å˜é‡
      - name: Set Shanghai time
        run: |
          CURRENT_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M %Z')
          echo "CURRENT_TIME=$CURRENT_TIME" >> $GITHUB_ENV

      # æ­¥éª¤ 4: æ£€å‡ºç›®æ ‡ä»“åº“
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SYNC_TOKEN }}
          repository: 13ztop/forward-panel
          path: target-repo
          ref: ${{ env.DEFAULT_BRANCH }}

      # æ­¥éª¤ 5: è®°å½•ç›®æ ‡ä»“åº“å½“å‰æäº¤
      - name: Record target commit
        id: target_commit
        run: |
          cd target-repo
          echo "LAST_SYNC_COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "è®°å½•ç›®æ ‡ä»“åº“å½“å‰æäº¤: $(git rev-parse --short HEAD)"

      # æ­¥éª¤ 6: å…‹éš†æºä»“åº“
      - name: Clone source repo
        run: |
          git clone --depth 1 https://github.com/bqlpfy/forward-panel.git source-repo
          cd source-repo
          echo "SOURCE_COMMIT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "SOURCE_COMMIT_LINK=https://github.com/bqlpfy/forward-panel/commit/$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "CURRENT_COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "æºä»“åº“å…‹éš†å®Œæˆï¼Œæœ€æ–°æäº¤: $(git rev-parse --short HEAD)"

      # æ­¥éª¤ 7: åˆ›å»ºå¤‡ä»½ç›®å½•
      - name: Create backup directory
        run: |
          mkdir -p /tmp/repo-backup
          echo "å¤‡ä»½ç›®å½•å·²åˆ›å»º"

      # æ­¥éª¤ 8: å¤‡ä»½ä¿æŠ¤æ–‡ä»¶
      - name: Backup protected files
        id: backup_files
        run: |
          protected_patterns=(
            "README*.md"
            "LICENSE*"
            ".github/workflows/*"
            "config/*"
            "*.env"
            "docker-compose*.yml"
            "data/*"
            "certs/*"
            "nginx.conf"
            "custom.json"
            ".gitignore"
          )
          
          # æŸ¥æ‰¾å¹¶å¤‡ä»½æ–‡ä»¶
          for pattern in "${protected_patterns[@]}"; do
            find target-repo -name "$pattern" -exec cp --parents -t /tmp/repo-backup {} + 2>/dev/null || true
          done
          
          # è®¡ç®—å¤‡ä»½æ–‡ä»¶æ•°é‡
          protected_count=$(find /tmp/repo-backup -type f | wc -l)
          echo "protected_files_count=$protected_count" >> $GITHUB_OUTPUT
          echo "å·²å¤‡ä»½ $protected_count ä¸ªä¿æŠ¤æ–‡ä»¶"

      # æ­¥éª¤ 9: æ‰§è¡ŒåŒæ­¥æ“ä½œ
      - name: Sync repositories
        run: |
          rsync -av --delete \
            --exclude=.git \
            --exclude="/tmp/repo-backup" \
            source-repo/ target-repo/
          echo "ä»“åº“å†…å®¹åŒæ­¥å®Œæˆ"

      # æ­¥éª¤ 10: æ¢å¤ä¿æŠ¤æ–‡ä»¶
      - name: Restore protected content
        run: |
          if [ -d "/tmp/repo-backup" ]; then
            cp -r /tmp/repo-backup/* target-repo/
            echo "å·²æ¢å¤ ${{ steps.backup_files.outputs.protected_files_count }} ä¸ªä¿æŠ¤æ–‡ä»¶"
          else
            echo "æ— ä¿æŠ¤æ–‡ä»¶éœ€è¦æ¢å¤"
          fi

      # æ­¥éª¤ 11: åˆ†æå˜æ›´ç±»å‹
      - name: Analyze changes
        id: analyze_changes
        if: success()
        run: |
          cd target-repo
          changes_count=$(git diff --name-only HEAD | wc -l)
          
          # ç»Ÿè®¡å„ç±»æ–‡ä»¶å˜æ›´æ•°é‡
          core_files=$(git diff --name-only HEAD | grep -E 'src/|lib/' | wc -l || echo 0)
          config_files=$(git diff --name-only HEAD | grep -E 'config/|\.env' | wc -l || echo 0)
          docs_files=$(git diff --name-only HEAD | grep -E 'README|docs/' | wc -l || echo 0)
          other_files=$((changes_count - core_files - config_files - docs_files))
          
          echo "changes_count=$changes_count" >> $GITHUB_OUTPUT
          echo "core_changes=$core_files" >> $GITHUB_OUTPUT
          echo "config_changes=$config_files" >> $GITHUB_OUTPUT
          echo "docs_changes=$docs_files" >> $GITHUB_OUTPUT
          echo "other_changes=$other_files" >> $GITHUB_OUTPUT
          
          echo "å˜æ›´åˆ†æå®Œæˆ:"
          echo "æ ¸å¿ƒæ–‡ä»¶: $core_files, é…ç½®æ–‡ä»¶: $config_files, æ–‡æ¡£: $docs_files, å…¶ä»–: $other_files"

      # æ­¥éª¤ 12: æäº¤å’Œæ¨é€å˜æ›´
      - name: Commit and push changes
        id: commit_push
        run: |
          cd target-repo
          git config user.name "GitHub Actions Sync"
          git config user.email "actions@github.com"
          git add -A
          
          if ! git diff-index --quiet HEAD --; then
            commit_msg="âœ… Auto Sync: bqlpfy/forward-panel@${{ env.SOURCE_COMMIT_HASH }}"
            commit_msg+="\n\nâ€¢ æ›´æ–°æ–‡ä»¶: ${{ steps.analyze_changes.outputs.changes_count }}"
            commit_msg+="\n  - æ ¸å¿ƒæ–‡ä»¶: ${{ steps.analyze_changes.outputs.core_changes }}"
            commit_msg+="\n  - é…ç½®æ–‡ä»¶: ${{ steps.analyze_changes.outputs.config_changes }}"
            commit_msg+="\n  - æ–‡æ¡£: ${{ steps.analyze_changes.outputs.docs_changes }}"
            commit_msg+="\n  - å…¶ä»–: ${{ steps.analyze_changes.outputs.other_changes }}"
            commit_msg+="\nâ€¢ ä¿ç•™æ–‡ä»¶: ${{ steps.backup_files.outputs.protected_files_count }}"
            commit_msg+="\nâ€¢ åŒæ­¥æ—¶é—´: ${{ env.CURRENT_TIME }}"
            
            git commit -m "$(echo -e "$commit_msg")"
            git push origin HEAD:${{ env.DEFAULT_BRANCH }}
            echo "å·²æäº¤å˜æ›´å¹¶æ¨é€"
          else
            echo "æ— å˜æ›´å¯æäº¤"
          fi

      # æ­¥éª¤ 13: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      - name: Cleanup
        run: |
          rm -rf source-repo
          rm -rf /tmp/repo-backup
          echo "ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"

      # æ­¥éª¤ 14: å¢å¼ºç‰ˆ Telegram é€šçŸ¥
      - name: Telegram Notification
        if: ${{ always() && env.TELEGRAM_ENABLED == 'true' }}
        uses: appleboy/telegram-action@v1.0.0
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          parse_mode: markdown
          message: |
            ${{ job.status == 'success' && 'âœ…' || 'âŒ' }} *${{ github.workflow }} åŒæ­¥æŠ¥å‘Š*
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            â€¢ **ä»“åº“**: [13ztop/forward-panel](${{ github.server_url }}/13ztop/forward-panel) (\`${{ env.DEFAULT_BRANCH }}\`)
            â€¢ **çŠ¶æ€**: ${{ job.status == 'success' && 'æˆåŠŸ' || 'å¤±è´¥' }}
            â€¢ **æºæäº¤**: [\`${{ env.SOURCE_COMMIT_HASH }}\`](${{ env.SOURCE_COMMIT_LINK }}) 
            â€¢ **åŒæ­¥æ—¶é—´**: ${{ env.CURRENT_TIME }}
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            â€¢ **æ–‡ä»¶å˜æ›´**: ${{ steps.analyze_changes.outputs.changes_count || '0' }}
              - æ ¸å¿ƒæ–‡ä»¶: ${{ steps.analyze_changes.outputs.core_changes || '0' }}
              - é…ç½®æ–‡ä»¶: ${{ steps.analyze_changes.outputs.config_changes || '0' }}
              - æ–‡æ¡£: ${{ steps.analyze_changes.outputs.docs_changes || '0' }}
              - å…¶ä»–: ${{ steps.analyze_changes.outputs.other_changes || '0' }}
            â€¢ **ä¿ç•™æ–‡ä»¶**: ${{ steps.backup_files.outputs.protected_files_count || '0' }}
            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            ğŸ” **ç›¸å…³é“¾æ¥**:
            - [æŸ¥çœ‹å˜æ›´å·®å¼‚](${{ github.server_url }}/13ztop/forward-panel/compare/${{ env.LAST_SYNC_COMMIT }}...${{ env.CURRENT_COMMIT }})
            - [æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
